<!DOCTYPE html>
<html lang="en" ng-app = 'myApp'>
<head>
	<meta charset="UTF-8">
	<title>friends</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
	<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
<script type='text/javascript' src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"> </script>
	<style>

	body{
		margin: 10px;
	}
	input{
		margin-bottom: 5px;
		margin-top: 5px;
	}
	</style>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.5/angular.min.js"/></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.5/angular-route.min.js"></script>
	<script>
		var myApp = angular.module('myApp',['ngRoute']);

		myApp.config(function($routeProvider){
			$routeProvider
			.when('/',{
				templateUrl : './partials/index.html'
			})
			.when('/node/:id',{
				templateUrl : './partials/node.html'
			})
			.otherwise({
				redirectTo: '/'
			});
		});

		//create a node factory
		myApp.factory('nodeFactory',function($http){
			factory = {};
			var nodes = [];
			factory.index = function(callback){
				console.log('nodeFactory is loading data');
				$http.get('/nodes').success(function(output){
					console.log(output);
					callback(output);
				})
			};
			factory.create = function(info,callback){
				console.log('nodeFactory.create');
				$http.post('/addNode/'+info.name).success(function(output){
					callback(output);
				})
			};
			factory.remove = function(id,callback){
				$http.post('/removeNode/'+id).success(function(output){
					console.log('nodeFactory.removeNode success');
					callback(output);
				})
			};
			factory.connect = function(id1,id2,callback){
				console.log('nodeFactory.connect');
				var info = {id1 : id1, id2 : id2};
				$http.post('/connect/',info).success(function(output){
					callback(output);
				})
			};
			factory.getNodeById = function(id,callback){
				$http.get('/getNodeById/'+id).success(function(output){
					callback(output);
				})
			};
			factory.disconnect = function(id1,id2,callback){
				console.log('nodeFactory.disconnect');
				var info = {id1 : id1, id2 : id2};
				$http.post('/disconnect/',info).success(function(output){
					callback(output);
				})
			};
			return factory;
		});

		//create an edge factory
		myApp.factory('edgeFactory',function($http){
			factory = {};
			var edges = [
			
			];

			factory.index = function(callback){
				console.log('edgeFactory is loading data.');
				$http.get('/edges').success(function(output){
					console.log('edgeFactory.index success');
					callback(output);
				})
			};
			factory.create = function(id1,id2,callback){
				console.log('edges.create');
				var info = {id1:id1,id2:id2};
				$http.post('/edges',info).success(function(output){
					callback(output);
				})
			};
			factory.remove = function(id1,id2,callback){
				
				var info = {id1:id1,id2:id2};
				$http.post('/removeEdges',info).success(function(output){
					console.log('edges.remove success');
					callback(output);
				})
			};
			
			return factory;
		})


		//main controller
		myApp.controller('mainController',function($scope,nodeFactory,edgeFactory){
			var getNodes = function(){
				nodeFactory.index(function(data){
					console.log(data);
					$scope.nodes = data;
				});
			}
			
			var getEdges = function(){
				edgeFactory.index(function(data){
					console.log(data);
					$scope.edges = data;
				});
			}
			
			getNodes();
			getEdges();

			$scope.addNode = function(){
				console.log('mainController.addNode');
				nodeFactory.create($scope.newNode,function(){
					$scope.newNode = {};

					nodeFactory.index(function(data){
						console.log(data);
						$scope.nodes = data;
					});
				})
			};
			$scope.removeNode = function(id){
				console.log('going to remove node with id: '+id);
				nodeFactory.remove(id,function(){
					nodeFactory.remove(id,function(data){
						getNodes();
						getEdges();
					});
				})
			};


		});

		//friends controller
		myApp.controller('friendController',function($scope,$window,$routeParams,nodeFactory,edgeFactory){
			var id = $routeParams.id;

			$scope.reload = function(){
				$window.location.reload();
			}

			var getNode = function(id){
				nodeFactory.getNodeById(id,function(data){
					console.log('getNode',data);
					$scope.node = data;
				});
			}
			

			var getNodes = function(){
				nodeFactory.index(function(data){
					console.log(data);
					$scope.nodes = data;

					$scope.obj = {};
					var cnt = 0;
					for(var key in data){
						if($scope.obj[data[key]._id] === undefined){
							$scope.obj[data[key]._id] = cnt;
							cnt++;
						}
					}
					console.log("scope.obj",$scope.obj);
					getEdges();
				});
			}
			
			var getEdges = function(){
				edgeFactory.index(function(data){
					
					$scope.edges = data;

					for(var key in $scope.edges){
						$scope.edges[key].source = $scope.obj[$scope.edges[key].source];
						$scope.edges[key].target = $scope.obj[$scope.edges[key].target];
					}
			        console.log("$scope.edges",$scope.edges);
			        setTimeout(draw(), 2000);
				});
			}

			$scope.isFriend = function(id2){
				for(var i = 0; i < $scope.node.friends.length; i++){
					if(id2 === id){
						return false;
					}
					if($scope.node.friends[i] === id2){
						return false;
					}
				}
				return true;
			};
			getNode(id);
			getNodes();
			

			$scope.connect = function(id2){
				nodeFactory.connect(id,id2,function(data){
					nodeFactory.connect(id2,id,function(data){
						edgeFactory.create(id,id2,function(data){
							getNode(id);
							getNodes();
							// getEdges();
							// draw();
							
						})
						
					})
				})
			};
			$scope.removeNode = function(id){
				console.log('going to remove node with id: '+id);
				nodeFactory.remove(id,function(){
					nodeFactory.remove(id,function(data){
						getNodes();
					});
				})
			};

			$scope.disconnect = function(id2){
				nodeFactory.disconnect(id,id2,function(data){
					nodeFactory.disconnect(id2,id,function(data){
						edgeFactory.remove(id,id2,function(data){
							getNode(id);
							getNodes();

							
						})
						
					})
				})
			};

			

			var draw = function(){

			//Width and height
			var w = 800;
			var h = 600;
			d3.select("svg").remove();
			var svg = d3.select("#display")
						.append("svg")
						.attr("width",w)
						.attr("height",h);

			var tip = d3.tip()
			    .attr('class', 'd3-tip')
			    .offset([-10, 0])
			    .html(function (d) {
			    return  d.name + "";
			})
			svg.call(tip);

			var colors = d3.scale.category10();

			var dataset = {
			        nodes: $scope.nodes,
			        edges: $scope.edges
			};
			console.log("dataset",dataset);

			var force = d3.layout.force()
                     .nodes(dataset.nodes)
                     .links(dataset.edges)
                     .size([w, h])
                     .start()
                     .linkDistance([50])       
                     .charge([-100])            
                     .start();

            var edges = svg.selectAll("line")
					        .data(dataset.edges)
					        .enter()
					        .append("line")
					        .style("stroke", "#ccc")
					        .style("stroke-width", 1);

			var nodes = svg.selectAll("circle")
					        .data(dataset.nodes)
					        .enter()
					        .append("circle")
					        .attr("r", 10)
					        .style("fill", function(d, i) {
					                return colors(i);
					        })
					        .call(force.drag)
					        .on('mouseover', tip.show)
					        .on('mouseout', tip.hide); //Added 

			force.on("tick", function() {

				edges.attr("x1", function(d) { return d.source.x; })
				     .attr("y1", function(d) { return d.source.y; })
				     .attr("x2", function(d) { return d.target.x; })
				     .attr("y2", function(d) { return d.target.y; });

				nodes.attr("cx", function(d) { return d.x; })
				     .attr("cy", function(d) { return d.y; });

				});
			}
		});


	</script>
</head>
<body>
	<div>
		<div ng-view = ''></div>
	</div>

</body>
</html>